════════════════════════════════════════════════════════════════════════════════════
  WD BLOCK NOTIFICATOR - ДИАГРАММА РАБОТЫ
════════════════════════════════════════════════════════════════════════════════════

┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                           ГЛАВНЫЙ ЦИКЛ (каждый час)                             ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

              ╔════════════════════════════════════════╗
              ║   ЗАПУСК ПРИЛОЖЕНИЯ                    ║
              ║   python main.py                       ║
              ╚════════════════════════════════════════╝
                            │
                            ▼
            ┌────────────────────────────────────┐
            │ Инициализация:                     │
            │ - Создание WD сессии               │
            │ - Подготовка к работе              │
            └────────────────────────────────────┘
                            │
                            ▼
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    ┃     БЕСКОНЕЧНЫЙ ЦИКЛ (while True)         ┃
    ┃   Повторяется каждый час (sleep 60*60)   ┃
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                            │
                            ▼
            ╔════════════════════════════════════╗
            ║   ЭТАП 1: ПРОВЕРКА ВРЕМЕНИ        ║
            ║   check_work_time()                ║
            ╚════════════════════════════════════╝
                            │
                    ┌───────┴────────┐
                    │                │
              ВНЕ РАБОТЫ        В РАБОТЕ
            (20:30-09:10)      (09:10-20:30)
                    │                │
                  СПИМ           ПРОДОЛЖАЕМ
                    │                │
                    └───────┬────────┘
                            ▼
            ╔════════════════════════════════════╗
            ║   ЭТАП 2: ПОЛУЧЕНИЕ ЧЁРНОГО       ║
            ║   СПИСКА ОТ WD                     ║
            ║   get_black_list()                 ║
            ╚════════════════════════════════════╝
                            │
                    ┌───────┴───────┐
                    │               │
                  200 OK         503 SERVICE
                    │          UNAVAILABLE
                    │               │
                    │         ┌─────▼──────┐
                    │         │ Пробуем    │
                    │         │ через      │
                    │         │ ПРОКСИ     │
                    │         └─────┬──────┘
                    │               │
                    │        ┌──────┴──────┐
                    │        │             │
                    │       ✓             ✗
                    │        │             │
                    ▼        ▼             ▼
            ┌──────────────────────────────────┐
            │ Получены данные о блокировках:  │
            │ {                                │
            │   'AA8732CC': 'причина 1',       │
            │   'AI3955IE': 'причина 2',       │
            │   'KA9628HA': 'причина 3'        │
            │ }                                │
            └──────────────────────────────────┘
                            │
                            ▼
    ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
    ┃   ЭТАП 3: ПРОВЕРКА ДЛЯ КАЖДОЙ         ┃
    ┃   ТАКСИКОМПАНИИ (цикл по 5 такси)    ┃
    ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    │
    ├─► FLY
    │   │
    │   ▼
    │   ┌──────────────────────────────────────┐
    │   │ 1) Подключиться к Firebird БД        │
    │   │    get_cardata(host, database)       │
    │   └──────────────────────────────────────┘
    │              │
    │      ┌───────┴──────────┐
    │      │                  │
    │    ✓ УСПЕХ          ✗ ОШИБКА
    │      │                  │
    │      ▼                  ▼
    │   Получили        Отправили ERROR
    │   список машин    в Telegram и Sentry
    │      │
    │      ▼
    │   ┌──────────────────────────────────────┐
    │   │ 2) Сравнить с чёрным списком         │
    │   │                                       │
    │   │ for carnum in black_list:             │
    │   │     if carnum in cars:                │
    │   │         found = True                  │
    │   └──────────────────────────────────────┘
    │              │
    │      ┌───────┴──────────┐
    │      │                  │
    │    НАЙДЕНА           НЕ НАЙДЕНА
    │    МАШИНА            МАШИНА
    │      │                  │
    │      ▼                  ▼
    │   ┌──────────────────────┐  Переходим к
    │   │ 3) Проверить БД      │  следующей
    │   │    (отправляли ли    │  машине в
    │   │    уведомление       │  чёрном списке
    │   │    раньше?)          │
    │   │                      │
    │   │ db.check_record()    │
    │   └──────────────────────┘
    │              │
    │      ┌───────┴──────────┐
    │      │                  │
    │   ОТПРАВЛЯЛИ        НЕ ОТПРАВЛЯЛИ
    │   РАНЬШЕ             РАНЬШЕ
    │      │                  │
    │      │                  ▼
    │      │            ┌──────────────────────┐
    │      │            │ 4) Собрать информацию│
    │      │            │                       │
    │      │            │ - Номер машины       │
    │      │            │ - Марка, год, цвет   │
    │      │            │ - Позывной           │
    │      │            │ - ФИО водителя       │
    │      │            │ - Телефоны           │
    │      │            │ - Баланс счёта       │
    │      │            │ - Последняя актив.   │
    │      │            │ - Проверка в полиции │
    │      │            │                       │
    │      │            │ police.check_in...() │
    │      │            └──────────────────────┘
    │      │                      │
    │      │                      ▼
    │      │            ┌──────────────────────┐
    │      │            │ 5) Отправить в       │
    │      │            │    Telegram          │
    │      │            │                       │
    │      │            │ send_message()       │
    │      │            │ ↓                    │
    │      │            │ @-353220657 (или    │
    │      │            │  другой чат)         │
    │      │            └──────────────────────┘
    │      │                      │
    │      │                      ▼
    │      │            ┌──────────────────────┐
    │      │            │ 6) Сохранить в БД    │
    │      │            │                       │
    │      │            │ db.insert_record(    │
    │      │            │   taxi='Fly',        │
    │      │            │   carnum='AA8732CC'  │
    │      │            │ )                    │
    │      │            └──────────────────────┘
    │      │
    │      └─────────────┬──────────────────┐
    │                    │                  │
    │            Переходим к следующей машине
    │
    ├─► JET
    │   │ (повторяем шаги 1-6 для Jet)
    │   └──► ...
    │
    ├─► MAGDACK
    │   │ (повторяем шаги 1-6 для Magdack)
    │   └──► ...
    │
    ├─► 898
    │   │ (повторяем шаги 1-6 для 898)
    │   └──► ...
    │
    └─► ALLO
        │ (повторяем шаги 1-6 для Allo)
        └──► ...


════════════════════════════════════════════════════════════════════════════════════
                            ОБРАБОТКА ОШИБОК
════════════════════════════════════════════════════════════════════════════════════

    ┌─────────────────────────────────────┐
    │ ОШИБКА В ЛЮБОМ МЕСТЕ ЦИКЛА          │
    └─────────────────────────────────────┘
                      │
                      ▼
        ┌──────────────────────────────┐
        │ error_count += 1              │
        │ logger.exception(error)       │
        └──────────────────────────────┘
                      │
        ┌─────────────┴──────────────┐
        │                            │
   error_count < 3               error_count >= 3
        │                            │
        ▼                            ▼
    Логируем         ┌──────────────────────────┐
    в файл           │ КРИТИЧЕСКИЙ АЛЕРТ!       │
                     │                          │
                     │ utils.send_error_        │
                     │ notification(            │
                     │   title='...',           │
                     │   message='...',         │
                     │   error_type='CRITICAL'  │
                     │ )                        │
                     │ ↓                        │
                     │ Telegram сообщение:      │
                     │ 🚨 CRITICAL ERROR        │
                     │ [описание]               │
                     │                          │
                     │ sentry_sdk.capture_      │
                     │ exception(e)             │
                     │ ↓                        │
                     │ Sentry dashboard:        │
                     │ [просмотреть на сайте]   │
                     │                          │
                     │ error_count = 0 (сброс)  │
                     └──────────────────────────┘


════════════════════════════════════════════════════════════════════════════════════
                        ТИПИЧНЫЙ ДЕНЬ (таблица)
════════════════════════════════════════════════════════════════════════════════════

ВРЕМЯ   │ ЧТО ПРОИСХОДИТ                      │ ДЕЙСТВИЕ
────────┼─────────────────────────────────────┼────────────────────────────
09:00   │ Приложение запущено                 │ python main.py
09:10   │ Проверка времени: в работе?         │ ДА
        │ Получение чёрного списка            │ ✓ 25 машин в чёрном списке
        │ Проверка Fly: найдено 3 машины      │ Отправлены 3 уведомления
        │ Проверка Jet: найдено 2 машины      │ Отправлены 2 уведомления
        │ Проверка других: не найдено         │ Спим
        │ Сон                                 │ 60 минут
────────┼─────────────────────────────────────┼────────────────────────────
10:10   │ Проверка времени: в работе?         │ ДА
        │ Получение чёрного списка            │ ✓ 25 машин (без изменений)
        │ Проверка машин                      │ Уже отправляли - пропускаем
        │ Сон                                 │ 60 минут
────────┼─────────────────────────────────────┼────────────────────────────
20:00   │ Проверка времени: в работе?         │ ДА (ещё 30 минут до конца)
        │ Получение чёрного списка            │ ✓ 27 машин (+ 2 новые)
        │ Проверка машин                      │ 2 новые машины найдены!
        │ Отправлены уведомления              │ Отправлены 2 уведомления
        │ Сон                                 │ 60 минут
────────┼─────────────────────────────────────┼────────────────────────────
21:10   │ Проверка времени: в работе?         │ НЕТ (работа закончилась)
        │ Пропускаем всё                      │ Просто спим!
        │ Сон                                 │ 60 минут
────────┼─────────────────────────────────────┼────────────────────────────
22:10   │ Проверка времени: в работе?         │ НЕТ
        │ Сон                                 │ 60 минут
────────┼─────────────────────────────────────┼────────────────────────────
...     │ Спим всю ночь...                    │
────────┼─────────────────────────────────────┼────────────────────────────
09:10   │ Проверка времени: в работе?         │ ДА (новый день)
        │ Получение чёрного списка            │ ✓
        │ Новый цикл начинается!              │ Начинаем сначала


════════════════════════════════════════════════════════════════════════════════════
                          СИСТЕМА ОПОВЕЩЕНИЙ
════════════════════════════════════════════════════════════════════════════════════

TELEGRAM BOT #1 (ОСНОВНОЙ)
├─ Назначение: Сообщения о заблокированных машинах
├─ Токен: TELEGRAM_BOT_TOKEN
├─ Чат: FLY_CHAT_ID, JET_CHAT_ID, и т.д. (разные группы для каждого такси)
├─ Пример сообщения:
│  ┌─────────────────────────────────────┐
│  │ AA8732CC - позывной: 8188            │
│  │ Daewoo Lanos, 2004, синій            │
│  │                                       │
│  │ Сенченко В.О.                        │
│  │ 0977353647                           │
│  │ Баланс: 0.0                          │
│  │                                       │
│  │ По полиции: ЗАЗ-DAEWOO 2004         │
│  │ Причина: Не соответствует требованиям│
│  └─────────────────────────────────────┘
└─ Частота: зависит от количества новых блокировок


TELEGRAM BOT #2 (ОШИБКИ)
├─ Назначение: Критические ошибки приложения
├─ Токен: TELEGRAM_ERROR_BOT_TOKEN
├─ Чат: TELEGRAM_ERROR_CHAT_ID (один администратору)
├─ Уровни оповещений:
│  ├─ 🟡 WARNING: WD вернул 503, пробуем через прокси
│  ├─ 🔴 ERROR: Не можем подключиться к Firebird
│  └─ 🚨 CRITICAL: 3 ошибки подряд - серьёзная проблема!
└─ Частота: только при проблемах


SENTRY (опционально)
├─ Назначение: Централизованное отслеживание ошибок
├─ Доступ: https://sentry.io (в веб-браузере)
├─ Информация:
│  ├─ Тип ошибки
│  ├─ Когда произошла
│  ├─ Сколько раз произошла
│  ├─ Какая строка кода виновата
│  ├─ Full stack trace
│  └─ Браузер, ОС, версия приложения
└─ Интеграция: сentry_sdk.capture_exception(e)


════════════════════════════════════════════════════════════════════════════════════
                        ЗАЩИТА ОТ БЛОКИРОВОК WD
════════════════════════════════════════════════════════════════════════════════════

ПРОБЛЕМА:
    WD может подумать "Это бот!" и вернуть 503 (забанить IP)


РЕШЕНИЯ (в порядке применения):

1️⃣ БРАУЗЕР-ПОДОБНЫЕ ЗАГОЛОВКИ
   ┌──────────────────────────────────────┐
   │ User-Agent: Mozilla/5.0 (Windows NT) │
   │ Accept: text/html, application/...   │
   │ Accept-Language: uk-UA, en           │
   │ DNT: 1                               │
   └──────────────────────────────────────┘
   WD видит: "Нормальный браузер, а не бот!"


2️⃣ ПАУЗЫ МЕЖДУ ЗАПРОСАМИ
   Запрос → Ждём 2 секунды → Следующий запрос
   (имитируем человека, который медленно кликает)


3️⃣ ПРОКСИ (если 503)
   if status_code == 503:
       try_with_proxy_1 → если ошибка
       try_with_proxy_2 → если ошибка
       try_with_proxy_3 → если ошибка
       Дать up


4️⃣ ПЕРЕПОДКЛЮЧЕНИЕ КАЖДЫЕ 6 ЧАСОВ
   Создаём новую сессию = новый Cookie
   WD видит это как новый пользователь


════════════════════════════════════════════════════════════════════════════════════
                          ОСНОВНЫЕ ФАЙЛЫ
════════════════════════════════════════════════════════════════════════════════════

main.py
├─ Главная программа
├─ Основной цикл (while True)
├─ Функции check_work_time(), get_black_list(), check()
└─ Отправка сообщений в Telegram

utils.py
├─ Помощник функции
├─ Функция make_request() для безопасных HTTP запросов
├─ Функция check_wd_availability() для проверки доступности
├─ Функция send_error_notification() для отправки ошибок
└─ Браузер-заголовки и логика работы с прокси

database.py
├─ SQLite работа
├─ Класс Database для проверки (отправляли ли уже)
└─ Таблица processed_cars

taxi_data.py
├─ Загрузка .env файла
├─ Функция get_tn_data() - получить данные такси
└─ Функция get_wd_credentials() - получить WD логин/пароль

police.py
├─ Парсер сайта baza-gai.com.ua
└─ Функция check_in_police() - проверка в полиции


════════════════════════════════════════════════════════════════════════════════════
